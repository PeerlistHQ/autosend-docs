---
title: "Supabase Edge Functions"
sidebarTitle: "Supabase Edge Functions"
description: "Learn how to send transactional emails from Supabase Edge Functions using AutoSend."
---

## Overview

This guide shows you how to integrate AutoSend with Supabase Edge Functions to send emails for authentication, notifications, and other transactional use cases. Edge Functions run at the edge, close to your users, making them perfect for handling email operations with low latency.

## Prerequisites

Before you begin, make sure you have:

- An <a href={{ type:"mdxJsxAttributeValueExpression",value:"AUTOSEND_BASE_URL",data:{estree:{type:"Program",start:630,end:647,body:[{type:"ExpressionStatement",expression:{type:"Identifier",start:630,end:647,loc:{start:{line:21,column:14,offset:630},end:{line:21,column:31,offset:647}},name:"AUTOSEND_BASE_URL",range:[630,647]},start:630,end:647,loc:{start:{line:21,column:14,offset:630},end:{line:21,column:31,offset:647}},range:[630,647]}],sourceType:"module",comments:[],loc:{start:{line:21,column:14,offset:630},end:{line:21,column:31,offset:647}},range:[630,647]}} }} title="AutoSend">
   AutoSend account</a>

   with an API key
- A <a href={{ type:"mdxJsxAttributeValueExpression",value:"SUPABASE",data:{estree:{type:"Program",start:717,end:725,body:[{type:"ExpressionStatement",expression:{type:"Identifier",start:717,end:725,loc:{start:{line:22,column:13,offset:717},end:{line:22,column:21,offset:725}},name:"SUPABASE",range:[717,725]},start:717,end:725,loc:{start:{line:22,column:13,offset:717},end:{line:22,column:21,offset:725}},range:[717,725]}],sourceType:"module",comments:[],loc:{start:{line:22,column:13,offset:717},end:{line:22,column:21,offset:725}},range:[717,725]}} }} title="Supabase">
  Supabase project</a>
- <a href={{ type:"mdxJsxAttributeValueExpression",value:"SUPABASE_DOCS_CLI",data:{estree:{type:"Program",start:776,end:793,body:[{type:"ExpressionStatement",expression:{type:"Identifier",start:776,end:793,loc:{start:{line:23,column:11,offset:776},end:{line:23,column:28,offset:793}},name:"SUPABASE_DOCS_CLI",range:[776,793]},start:776,end:793,loc:{start:{line:23,column:11,offset:776},end:{line:23,column:28,offset:793}},range:[776,793]}],sourceType:"module",comments:[],loc:{start:{line:23,column:11,offset:776},end:{line:23,column:28,offset:793}},range:[776,793]}} }} title="Supabase docs">
  Supabase CLI</a>

   installed (v1.0 or later)
- Node.js 18+ installed locally

## Quick Start

### 1. Create a Supabase Edge Function

Initialize your Supabase project and create a new Edge Function:

```bash
# Login to Supabase
supabase login

# Initialize your project (if not already done)
supabase init

# Create a new Edge Function
supabase functions new autosend
```

This creates a new function in `supabase/functions/autosend/index.ts`.

### 2. Install Dependencies

Edge Functions support importing from standard URLs. No package installation needed!

### 3. Write the Edge Function

Replace the content of `supabase/functions/autosend/index.ts` with:

```tsx
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import { corsHeaders } from '../_shared/cors.ts'

serve(async (req) => {
  // Handle CORS preflight requests
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    const { to, from, subject, html, templateId, dynamicData } = await req.json()

    // Get AutoSend API key from environment variables
    const autoSendApiKey = Deno.env.get('AUTOSEND_API_KEY')

    if (!autoSendApiKey) {
      throw new Error('AUTOSEND_API_KEY not configured')
    }

    // Prepare email payload
    const emailPayload: any = {
      to: {
        email: to.email,
        name: to.name || undefined
      },
      from: {
        email: from.email,
        name: from.name || undefined
      }
    }

    // Add template or HTML content
    if (templateId) {
      emailPayload.templateId = templateId
      if (dynamicData) {
        emailPayload.dynamicData = dynamicData
      }
    } else {
      emailPayload.subject = subject
      emailPayload.html = html
    }

    // Send email via AutoSend API
    const response = await fetch('https://api.autosend.com/v1/mails/send', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${autoSendApiKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(emailPayload)
    })

    const data = await response.json()

    if (!response.ok) {
      throw new Error(data.message || 'Failed to send email')
    }

    return new Response(
      JSON.stringify({
        success: true,
        emailId: data.data.emailId,
        status: data.data.status
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 200,
      },
    )
  } catch (error) {
    return new Response(
      JSON.stringify({
        success: false,
        error: error.message
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 400,
      },
    )
  }
})
```

### 4. Create Shared CORS Configuration

Create a file at `supabase/functions/_shared/cors.ts`:

```tsx
export const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}
```

### 5. Set Environment Variables

Create a `.env` file in your project root (for local development):

```bash
AUTOSEND_API_KEY=your_autosend_api_key_here
```

For production, set secrets using the Supabase CLI:

```bash
supabase secrets set AUTOSEND_API_KEY=your_autosend_api_key_here
```

### 6. Run Locally

Test your function locally before deploying:

```bash
supabase functions serve autosend --env-file .env --no-verify-jwt
```

The function will be available at: `http://localhost:54321/functions/v1/autosend`

### 7. Test Your Function

Send a test request using cURL:

```bash
curl -i --location --request POST 'http://localhost:54321/functions/v1/autosend' \
  --header 'Authorization: Bearer YOUR_SUPABASE_ANON_KEY' \
  --header 'Content-Type: application/json' \
  --data '{
    "to": {
      "email": "[email protected]",
      "name": "John Doe"
    },
    "from": {
      "email": "[email protected]",
      "name": "Your App"
    },
    "subject": "Welcome to our platform!",
    "html": "<h1>Hello John!</h1><p>Welcome aboard!</p>"
  }'
```

### 8. Deploy to Production

Once tested, deploy your function:

```bash
supabase functions deploy autosend
```

Your function will be available at:

```
https://YOUR_PROJECT_REF.supabase.co/functions/v1/autosend
```

## Usage Examples

### Send a Simple Email

```jsx
const { data, error } = await supabase.functions.invoke('autosend', {
  body: {
    to: {
      email: '[email protected]',
      name: 'Jane Smith'
    },
    from: {
      email: '[email protected]',
      name: 'MyApp'
    },
    subject: 'Welcome!',
    html: '<h1>Welcome to MyApp!</h1><p>We are excited to have you.</p>'
  }
})

if (error) {
  console.error('Error sending email:', error)
} else {
  console.log('Email sent:', data)
}
```

### Send Using AutoSend Template

```jsx
const { data, error } = await supabase.functions.invoke('autosend', {
  body: {
    to: {
      email: '[email protected]',
      name: 'Jane Smith'
    },
    from: {
      email: '[email protected]',
      name: 'MyApp'
    },
    templateId: 'tmpl_welcome_email',
    dynamicData: {
      firstName: 'Jane',
      loginUrl: 'https://app.example.com/login'
    }
  }
})
```

### Send from React/Next.js

```jsx
const sendEmail = async () => {
  const response = await fetch(
    'https://YOUR_PROJECT_REF.supabase.co/functions/v1/autosend',
    {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${supabaseAnonKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        to: {
          email: '[email protected]',
          name: 'John Doe'
        },
        from: {
          email: '[email protected]',
          name: 'MyApp'
        },
        subject: 'Order Confirmation',
        html: '<p>Your order has been confirmed!</p>'
      })
    }
  )

  const data = await response.json()
  return data
}
```

## Integration with Supabase Auth

You can use AutoSend to send custom authentication emails by integrating with Supabase Auth Hooks.

### 1. Create Auth Hook Function

Create a new function for auth emails:

```bash
supabase functions new send-auth-email
```

### 2. Implement Auth Hook Handler

```tsx
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"

serve(async (req) => {
  try {
    const payload = await req.json()
    const { event_type, user, token_hash, redirect_to } = payload

    const autoSendApiKey = Deno.env.get('AUTOSEND_API_KEY')

    let templateId: string
    let dynamicData: any = {}

    // Map event types to templates
    switch (event_type) {
      case 'user.signup':
        templateId = 'tmpl_signup_confirmation'
        dynamicData = {
          confirmationUrl: `${redirect_to}?token_hash=${token_hash}&type=signup`,
          email: user.email
        }
        break

      case 'user.password_recovery':
        templateId = 'tmpl_password_reset'
        dynamicData = {
          resetUrl: `${redirect_to}?token_hash=${token_hash}&type=recovery`,
          email: user.email
        }
        break

      case 'user.email_change':
        templateId = 'tmpl_email_change'
        dynamicData = {
          confirmationUrl: `${redirect_to}?token_hash=${token_hash}&type=email_change`,
          newEmail: user.new_email
        }
        break

      default:
        throw new Error(`Unsupported event type: ${event_type}`)
    }

    // Send email via AutoSend
    const response = await fetch('https://api.autosend.com/v1/mails/send', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${autoSendApiKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        to: {
          email: user.email
        },
        from: {
          email: '[email protected]',
          name: 'Your App'
        },
        templateId,
        dynamicData
      })
    })

    const data = await response.json()

    if (!response.ok) {
      throw new Error(data.message || 'Failed to send auth email')
    }

    return new Response(
      JSON.stringify({ success: true }),
      {
        headers: { 'Content-Type': 'application/json' },
        status: 200,
      },
    )
  } catch (error) {
    return new Response(
      JSON.stringify({ error: error.message }),
      {
        headers: { 'Content-Type': 'application/json' },
        status: 400,
      },
    )
  }
})
```

### 3. Configure Auth Hook in Supabase

1. Go to **Authentication \> Hooks** in your Supabase dashboard
2. Enable the "Send Email" hook
3. Set the hook URL to your deployed function:

   ```
   https://YOUR_PROJECT_REF.supabase.co/functions/v1/send-auth-email
   
   ```
4. Configure the secret (optional but recommended)

Now all Supabase Auth emails will be sent through AutoSend!

## Error Handling

Implement robust error handling for production:

```tsx
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"

serve(async (req) => {
  try {
    const payload = await req.json()

    // Validate required fields
    if (!payload.to?.email) {
      throw new Error('Recipient email is required')
    }

    if (!payload.from?.email) {
      throw new Error('Sender email is required')
    }

    const autoSendApiKey = Deno.env.get('AUTOSEND_API_KEY')

    if (!autoSendApiKey) {
      throw new Error('AutoSend API key not configured')
    }

    const response = await fetch('https://api.autosend.com/v1/mails/send', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${autoSendApiKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload)
    })

    const data = await response.json()

    // Handle AutoSend API errors
    if (!response.ok) {
      console.error('AutoSend API Error:', data)

      switch (response.status) {
        case 400:
          throw new Error(`Validation error: ${data.message}`)
        case 401:
          throw new Error('Invalid API key')
        case 403:
          throw new Error('Domain not verified or insufficient permissions')
        case 429:
          throw new Error('Rate limit exceeded. Please try again later.')
        default:
          throw new Error(data.message || 'Failed to send email')
      }
    }

    return new Response(
      JSON.stringify({
        success: true,
        emailId: data.data.emailId,
        status: data.data.status
      }),
      {
        headers: { 'Content-Type': 'application/json' },
        status: 200,
      },
    )
  } catch (error) {
    console.error('Function Error:', error)

    return new Response(
      JSON.stringify({
        success: false,
        error: error.message
      }),
      {
        headers: { 'Content-Type': 'application/json' },
        status: 400,
      },
    )
  }
})
```

## Best Practices

### 1. Environment Variables

Always use environment variables for sensitive data:

```tsx
// ✅ Good
const apiKey = Deno.env.get('AUTOSEND_API_KEY')

// ❌ Bad - Never hardcode
const apiKey = 'as_123456789'
```

### 2. Validate Email Addresses

Validate email formats before sending:

```tsx
function isValidEmail(email: string): boolean {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
  return emailRegex.test(email)
}

if (!isValidEmail(payload.to.email)) {
  throw new Error('Invalid email address')
}
```

### 3. Use Templates

Store email designs as templates in AutoSend for:

- Consistent branding
- Easier updates
- Better performance

### 4. Implement Rate Limiting

Protect your function from abuse:

```tsx
// Use Supabase Rate Limiting or implement custom logic
const userRateLimit = await checkUserRateLimit(userId)
if (!userRateLimit.allowed) {
  throw new Error('Rate limit exceeded')
}
```

### 6. Use Verified Domains

Always send from verified domains in AutoSend to ensure deliverability. [Learn how to verify domains →](https://docs.autosend.com/domain-configuration)

## Testing

### Test Function Locally

```bash
# Start local development server
supabase functions serve send-email --env-file .env

# Test with curl
curl -i --location --request POST 'http://localhost:54321/functions/v1/send-email' \
  --header 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...' \
  --header 'Content-Type: application/json' \
  --data '{
    "to": { "email": "[email protected]" },
    "from": { "email": "[email protected]" },
    "subject": "Test Email",
    "html": "<p>This is a test</p>"
  }'
```